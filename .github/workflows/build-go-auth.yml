name: build-go-auth

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout mosquitto-go-auth
        uses: actions/checkout@v4
        with:
          repository: iegomez/mosquitto-go-auth
          path: mosquitto-go-auth

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git make gcc pkg-config wget ca-certificates \
            mosquitto-dev libmosquitto-dev

      - name: Install Go
        run: |
          GO_VER=1.24.3
          wget -q https://go.dev/dl/go${GO_VER}.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf go${GO_VER}.linux-amd64.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          go version

      - name: Build plugin
        run: |
          cd mosquitto-go-auth
          make
          ls -lah go-auth.so

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-auth-so
          path: mosquitto-go-auth/go-auth.so

